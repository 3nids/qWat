*************************
Customize local DB models
*************************

DISCLAIMER: This section is being rewritten with the new PostgreSQL Update Manager (PUM). The versionning logic has changed and local customization still need some more work.

Customizing the data model
==========================

This part concerns the modification of the data model to add specific objects, on top on QWAT core data model.
While there is full freedom for using PostGIS and PostgreSQL capabilities, here are the conventions and good practices for the QWAT project.

Allowed customization for QWAT are :Â 
* Adding a custom field
* Adding a custom table

No change of the core data model is allowed ( field names, types, constraints...), or you should [[ask for the QWAT data model to be modified centrally|Contributors_guide#data-model-changes]].


Adding a field
==============

If you want to add a field to one of the core data model tables, follow these steps

* Store all modifications as separate SQL scripts. NEVER modify directly your database structure.
* Any added field or table **must** have the prefix `usr_`
* keep in mind that most views are generated by the initialization script. The field will be automatically added to the views if you use the initialization process and include pre and post file to drop and recreate the views.
* The simplest approach is to keep one unique SQL script applied after all core delta upgrade files. Currently (1.3.0) the file must named like "vx.x.x_" and version number must be higher than latest core data model.

Example : adding a paint color information to hydrants

* 1 : add the attribute with pgadmin ( you could also directly type SQL to modify the model)
* 2 : add the following SQL equivalent instruction to a `usr_model.sql` file

.. code-block:: sql
   :linenos:

   ALTER TABLE qwat_od.hydrant ADD COLUMN usr_color integer;

* 3 : add the following SQL instruction to a `usr_model_drop.sql` file

.. code-block:: sql
   :linenos:

    ALTER TABLE qwat_od.hydrant DROP COLUMN usr_color ;


Adding a table
==============

Custom tables go to specific schemas prefixed with `usr_` . If you want to have additional custom tables, you should first ensure that such a custom schema exists.

If you want to add a table follow these steps

* Create a custom schema prefixed with `usr_`
* Add your table in this schema ( table name is free)
* You **should** write corresponding diff code against the core data model ( see example below )
* You **could** write corresponding delete diff code against the core data model ( see example below )

Example : adding color informations to hydrants

* 1 : add the `usr_cityservices` schema, and the `hydrant_paint` table with pgadmin ( you could also directly type SQL to modify the model)
* 2 : add the following SQL equivalent instruction to a `usr_model.sql` file

.. code-block:: sql
   :linenos:

    CREATE SCHEMA usr_cityservices;
    CREATE TABLE usr_cityservices.hydrant_paint (
    id serial
    , fk_hydrant integer
    , color varchar
    , paint_date timestamp
    );
    ALTER TABLE usr_cityservices.hydrant_paint ADD CONSTRAINT hydrant_fk FOREIGN KEY (fk_hydrant) REFERENCES qwat_od.hydrant(id) MATCH FULL;


* 3 : add the following SQL instruction to a `usr_model_drop.sql` file

.. code-block:: sql
   :linenos:

    ALTER TABLE usr_cityservices.hydrant_paint DROP CONSTRAINT hydrant_fk;
    DROP TABLE usr_cityservices.hydrant_paint;
    DROP SCHEMA usr_cityservices;
